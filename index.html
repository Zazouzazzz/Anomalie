<script>
(() => {
  // =========================
  // CONFIG À REMPLACER
  // =========================
  const SUPABASE_URL = "https://tmwhcygiwfpnuzbvgyjf.supabase.co"; // OK
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtd2hjeWdpd2ZwbnV6YnZneWpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMTQzMDYsImV4cCI6MjA4MjU5MDMwNn0.0-9lkwRF2d7B6fLy1YBInjpQ7Lv7m4-l9fsQ9x66hKU"; // Settings > API > anon/public
  const SUPABASE_TABLE = "events";

  // Ton Edge Function (RESTORE)
  const EDGE_GET_EVENTS_URL =
    "https://tmwhcygiwfpnuzbvgyjf.functions.supabase.co/get-events-by-key";

  // =========================
  // HELPERS DOM
  // =========================
  const el = (id) => document.getElementById(id);

  // Ces ids doivent exister dans ton HTML
  const $ = {
    input: el("anomalyInput"),
    enter: el("enterBtn"),
    log: el("log"),
    langSelect: el("langSelect"),

    // (si présents)
    userKeyView: el("userKeyView"),
    copyKeyBtn: el("copyKeyBtn"),
    newKeyBtn: el("newKeyBtn"),
    restoreKeyInput: el("restoreKeyInput"),
    restoreBtn: el("restoreBtn"),

    toast: el("toast"),
    toastTitle: el("toastTitle"),
    toastText: el("toastText"),

    // Consent banner (si présents)
    banner: el("consentBanner"),
    shareToggle: el("shareToggle"),
    geoToggle: el("geoToggle"),
    bannerLater: el("bannerLater"),
    bannerAccept: el("bannerAccept"),
  };

  // =========================
  // STORAGE
  // =========================
  const store = {
    get(k, fallback) {
      try {
        const v = localStorage.getItem(k);
        return v ? JSON.parse(v) : fallback;
      } catch {
        return fallback;
      }
    },
    set(k, v) {
      try {
        localStorage.setItem(k, JSON.stringify(v));
      } catch {}
    },
  };

  // =========================
  // USER KEY (identité)
  // =========================
  function genUserKey() {
    const raw = (crypto && crypto.randomUUID)
      ? crypto.randomUUID().replaceAll("-", "")
      : (Date.now().toString(16) + Math.random().toString(16).slice(2));
    const part = raw.toUpperCase().slice(0, 16);
    return "ANOM-" + part.slice(0, 4) + "-" + part.slice(4, 8) + "-" + part.slice(8, 12) + "-" + part.slice(12, 16);
  }

  let userKey = store.get("userKey", null);
  if (!userKey) {
    userKey = genUserKey();
    store.set("userKey", userKey);
  }

  // =========================
  // CONSENT + GEO (optionnel)
  // =========================
  let consent = store.get("consent", { share: false, geo: false, decided: false });

  let tz = "";
  try { tz = Intl.DateTimeFormat().resolvedOptions().timeZone || ""; } catch { tz = ""; }
  let gps = null;

  function requestGeoIfAllowed() {
    if (!consent.geo) return;
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        gps = `GPS:${pos.coords.latitude.toFixed(5)},${pos.coords.longitude.toFixed(5)}`;
      },
      () => { gps = null; },
      { enableHighAccuracy: false, timeout: 2500, maximumAge: 600000 }
    );
  }

  function autoLocation() {
    // Si GPS accepté et obtenu => GPS..., sinon timezone
    return gps || tz || "LOCAL";
  }

  function showBannerIfNeeded() {
    if (!$.banner) return;
    if (consent.decided) return;
    if ($.shareToggle) $.shareToggle.checked = !!consent.share;
    if ($.geoToggle) $.geoToggle.checked = !!consent.geo;
    $.banner.style.display = "block";
  }

  function saveConsentFromUI() {
    consent = {
      share: $.shareToggle ? $.shareToggle.checked : false,
      geo: $.geoToggle ? $.geoToggle.checked : false,
      decided: true
    };
    store.set("consent", consent);
    if ($.banner) $.banner.style.display = "none";
    requestGeoIfAllowed();
  }

  // =========================
  // UI helpers
  // =========================
  const pad = (n) => String(n).padStart(2, "0");

  function nowStamp() {
    const d = new Date();
    const date = `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()}`;
    const time = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    return { date, time, iso: d.toISOString() };
  }

  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, (c) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[c]));
  }

  function toast(title, text) {
    if (!$.toast) return;
    if ($.toastTitle) $.toastTitle.textContent = title || "";
    if ($.toastText) $.toastText.textContent = text || "";
    $.toast.classList.add("show");
    window.setTimeout(() => $.toast.classList.remove("show"), 900);
  }

  // =========================
  // DATA local
  // =========================
  let anomalies = store.get("anomalies", []);
  let lang = store.get("lang", "fr");

  function renderLog() {
    if (!$.log) return;
    const list = anomalies.slice(0, 12);
    if (!list.length) {
      $.log.innerHTML = `<div class="muted" style="text-align:center; padding:10px 0;">Aucune anomalie détectée. Matrice stable.</div>`;
      return;
    }

    $.log.innerHTML = list.map(a => `
      <div class="entry">
        <div class="text">&gt; ${escapeHtml(a.text)}</div>
        <div class="meta">
          <span>[DATA: ${escapeHtml(a.date)}] [${escapeHtml(a.time)}]</span>
          <span>[LIEU: ${escapeHtml(a.location || "-")} ]</span>
        </div>
      </div>
    `).join("");
  }

  function refreshUserKeyUI() {
    if ($.userKeyView) $.userKeyView.textContent = userKey;
  }

  // =========================
  // CLOUD: INSERT (REST)
  // =========================
  async function sendToServer(entry) {
    if (!consent.share) return;

    // sécurité: si la anon key n’est pas mise, on n’envoie pas
    if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.includes("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtd2hjeWdpd2ZwbnV6YnZneWpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMTQzMDYsImV4cCI6MjA4MjU5MDMwNn0.0-9lkwRF2d7B6fLy1YBInjpQ7Lv7m4-l9fsQ9x66hKU")) return;

    const url = `${SUPABASE_URL}/rest/v1/${SUPABASE_TABLE}`;
    const payload = {
      user_key: userKey,
      text: entry.text,
      lang: entry.lang,
      location: entry.location,
      event_time: entry.iso,
      client_time: `${entry.date} ${entry.time}`
    };

    try {
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": "Bearer " + SUPABASE_ANON_KEY,
          "Content-Type": "application/json",
          "Prefer": "return=minimal"
        },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const msg = await res.text();
        console.warn("Insert failed:", msg);
      }
    } catch (e) {
      console.warn("Insert failed:", e);
    }
  }

  // =========================
  // CLOUD: RESTORE (Edge Function)
  // =========================
  async function restoreFromEdge(key) {
    try {
      const res = await fetch(EDGE_GET_EVENTS_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_key: key, limit: 200 })
      });

      const text = await res.text();
      if (!res.ok) {
        console.warn("Restore failed:", text);
        toast("RESTORE", "Restauration impossible.");
        return;
      }

      const data = JSON.parse(text);
      const rows = Array.isArray(data?.events) ? data.events : [];

      anomalies = rows.map(r => {
        let date = "-", time = "-";
        if (r.client_time && typeof r.client_time === "string") {
          const parts = r.client_time.split(" ");
          date = parts[0] || "-";
          time = parts[1] || "-";
        } else if (r.event_time) {
          const d = new Date(r.event_time);
          date = `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
          time = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }
        return {
          text: r.text || "",
          lang: r.lang || lang,
          location: r.location || "-",
          date, time,
          iso: r.event_time || new Date().toISOString()
        };
      });

      store.set("anomalies", anomalies);
      renderLog();
      toast("RESTORE", "Liste restaurée.");
    } catch (e) {
      console.warn("Restore failed:", e);
      toast("RESTORE", "Restauration impossible.");
    }
  }

  // =========================
  // ADD ANOMALY
  // =========================
  async function addAnomaly() {
    const raw = ($.input?.value || "").trim();
    if (!raw) return;

    const { date, time, iso } = nowStamp();
    const entry = {
      text: raw,
      date,
      time,
      iso,
      lang,
      location: autoLocation()
    };

    anomalies = [entry, ...anomalies];
    store.set("anomalies", anomalies);
    if ($.input) $.input.value = "";
    renderLog();

    toast("SAVED", entry.location ? `${entry.text} @ ${entry.location}` : entry.text);

    await sendToServer(entry);
  }

  // =========================
  // EVENTS
  // =========================
  if ($.enter) $.enter.addEventListener("click", addAnomaly);
  if ($.input) $.input.addEventListener("keydown", (e) => { if (e.key === "Enter") addAnomaly(); });

  if ($.langSelect) {
    $.langSelect.addEventListener("change", () => {
      lang = $.langSelect.value;
      store.set("lang", lang);
    });
  }

  if ($.copyKeyBtn) {
    $.copyKeyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(userKey);
        toast("ID", "Clé copiée.");
      } catch {
        toast("ID", "Copie impossible.");
      }
    });
  }

  if ($.newKeyBtn) {
    $.newKeyBtn.addEventListener("click", () => {
      userKey = genUserKey();
      store.set("userKey", userKey);
      refreshUserKeyUI();
      toast("ID", "Nouvelle clé créée.");
    });
  }

  if ($.restoreBtn) {
    $.restoreBtn.addEventListener("click", async () => {
      const k = ($.restoreKeyInput?.value || "").trim().toUpperCase();
      if (!k.startsWith("ANOM-")) {
        toast("RESTORE", "Clé invalide.");
        return;
      }
      userKey = k;
      store.set("userKey", userKey);
      refreshUserKeyUI();
      await restoreFromEdge(userKey);
    });
  }

  if ($.bannerLater) {
    $.bannerLater.addEventListener("click", () => {
      consent = { share: false, geo: false, decided: true };
      store.set("consent", consent);
      if ($.banner) $.banner.style.display = "none";
      gps = null;
    });
  }

  if ($.bannerAccept) {
    $.bannerAccept.addEventListener("click", saveConsentFromUI);
  }

  // =========================
  // INIT
  // =========================
  showBannerIfNeeded();
  requestGeoIfAllowed();
  refreshUserKeyUI();
  renderLog();
})();
</script>
